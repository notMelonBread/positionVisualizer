# テスト実行ガイド

## 1. テスト環境の概要

レバー制御ファームウェアのテスト環境は、以下の3つのレベルで構成されています：

1. **ユニットテスト**: 個々のコンポーネント（クラス/関数）をPC上で検証
2. **統合テスト**: シリアル通信テストハーネスを使用した各機能の連携検証
3. **システムテスト**: 実機上での総合動作確認

## 2. テスト実行手順

### 2.1 ユニットテスト

#### 前提条件
- PlatformIOのインストール
- 必要なライブラリ（ArduinoFake, Unity）がインストールされていること

#### 実行コマンド

```bash
# すべてのユニットテストを実行
platformio test -e native

# 特定のテストのみ実行
platformio test -e native -f test_calibration

# カバレッジレポートを生成
platformio test -e test_coverage
```

#### テスト結果の確認

テスト実行後、以下の場所に結果が出力されます：

- テスト結果: `.pio/build/native/test_output.txt`
- カバレッジレポート: `coverage_report/index.html`

### 2.2 シリアル通信テストハーネス

#### 前提条件
- Pythonのインストール
- `pyserial`パッケージのインストール (`pip install pyserial`)
- マイコンとPCがシリアル接続されていること

#### 実行コマンド

```bash
# 対話モード
python tools/serial_test_harness/serial_test_harness.py --port [ポート名]

# 自動テストモード
python tools/serial_test_harness/serial_test_harness.py --port [ポート名] --auto

# 詳細オプション
python tools/serial_test_harness/serial_test_harness.py --help
```

#### シリアルポートの指定

- Windows: `COM1`, `COM2`, ...
- Linux: `/dev/ttyUSB0`, `/dev/ttyACM0`, ...
- macOS: `/dev/tty.usbserial-*`

#### テスト結果の保存

自動テスト実行時、以下のファイルが生成されます：
- `test_log.json`: 生データログ
- `test_results.csv`: テスト結果サマリー

### 2.3 システムテスト

実機を使用した総合動作確認のためのチェックリスト：

#### 基本機能テスト
- [ ] 起動シーケンスが正常に表示される
- [ ] センサー値が読み取られLEDに表示される
- [ ] キャリブレーションボタンが機能する
- [ ] キャリブレーションデータが永続化される

#### エラー処理テスト
- [ ] センサー値異常（固定値）の検出と表示
- [ ] キャリブレーション範囲不正の検出と表示
- [ ] ボタン異常（長押し）の検出と表示

#### 通信テスト
- [ ] JSONデータが正しく送信される
- [ ] コマンドを正常に受信し処理できる
- [ ] エラー状態が通知される

## 3. テスト計画と実施記録

### テスト計画

1. すべてのコンポーネントの単体テスト実施
2. シリアル通信テストハーネスによる統合テスト
3. 実機を使用したシステムテスト
4. エッジケーステスト（異常値、エラー条件）

### テスト実施記録フォーマット

```markdown
# テスト実施記録

## テスト基本情報
- 日付: YYYY-MM-DD
- ファームウェアバージョン: vX.Y.Z
- テスト担当者: 名前
- テスト環境: 環境の詳細

## テスト結果サマリー
- 実施テスト数: XX
- 成功: XX
- 失敗: XX
- スキップ: XX

## 詳細結果
| テストID | テスト内容 | 結果 | 備考 |
|---------|----------|------|------|
| UT-001  | キャリブレーション関数 | 成功 | |
| IT-001  | シリアル通信 | 成功 | |
| ST-001  | 起動シーケンス | 失敗 | エラーメッセージが表示されない |

## 不具合・課題リスト
1. エラーXXXが発生した場合にLEDが点灯しない
2. キャリブレーションボタンの応答が遅い

## 対応計画
1. エラー表示機能の修正（担当: XX、期限: YYYY-MM-DD）
2. ボタン読み取り処理の最適化（担当: XX、期限: YYYY-MM-DD）
```

## 4. カバレッジ目標

- **ラインカバレッジ**: 80%以上
- **分岐カバレッジ**: 70%以上
- **関数カバレッジ**: 90%以上